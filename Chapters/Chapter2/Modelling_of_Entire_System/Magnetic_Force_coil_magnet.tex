\subsection{Magnetic force between magnet and coil}
To calculate the magnetic repulsion force between the coil and a permanent magnet we consider them aligned with their centers coinciding on the z-axis.
\begin{figure}
    \centering
    \includegraphics[scale=0.4]{Chapters/Chapter2/Modelling_of_Entire_System/Figures/coil_magnet.png} % TODO: Make a better image
    \caption[Coil-Magnet position]{Coil and magnet position in space.}
    \label{fig:Coil-Magnet position}
\end{figure}

The force between a magnet and a coil can be calculated using the magnetic field generated by the coil and magnet.
Knowing their closed-form expression we can calculate the force using this formula:
\begin{equation}
    F = \nabla (\overrightarrow{m_M} \cdot \overrightarrow{B_C}) % TODO: trovare fonte migliore di https://en.wikipedia.org/wiki/Magnetic_levitation
\end{equation}

Where: 
\begin{itemize}
    \item $\overrightarrow{m_M}$ is the magnetic moment of the magnet [A/m]
    \item $\overrightarrow{B_C}$ is the magnetic field generated by the coil [T]
\end{itemize}

The magnetic momentum of the magnet is defined as:
\begin{equation}
    \overrightarrow{m_M} = 
    \begin{pmatrix}
        0 & 0 & \frac{B_M(z)}{\mu}
    \end{pmatrix}
\end{equation}

Where:
\begin{itemize}
    \item $B_M(z)$ is the magnetic field generated by the permanent magnet [T]
    \item $\mu$ is the magnetic permeability of the medium [H/m]
\end{itemize}

We can calculate the magnetic field generated by the coil at a distance using equation \ref{eq:Spiral_magn_field_dist} (considering our coil as two in parallel) and the magnetic field generated by a cylindrical magnet at a distance $z$ using equation \ref{eq:Magnetic_field_perm_magnet}.

Doing the calculations, the resulting force in function of the distance $z$ is given by:
\begin{equation}
    F = \frac{ B_r I N R_C^2 \left(\frac{1}{\sqrt{\sigma_1}} - \frac{1}{\sqrt{\sigma_2}} + \frac{z^2}{\sigma_2^{3/2}} - \frac{2(t+z)^2}{2\sigma_1^{3/2}}\right)}{2\sigma_3^{3/2}} + B_C(I) \cdot \frac{3z \left(\frac{z}{\sqrt{\sigma_2}} - \frac{t+z}{\sqrt{\sigma_1}}\right)}{2\sigma_3}
\end{equation}
Where:
\begin{itemize}
    \item $N$ is the number of spires of a one-layer coil
    \item $I$ is the current flowing through the coil [A]
    \item $B_C$ is the coil magnetic field calculated as in \ref{eq:Spiral_magn_field_dist} [T]
    \item $R_C$ is the coil average radius ($r'$ in equation \ref{eq:Spiral_magn_field_dist}) [m]
    \item $\sigma_1 = R_M^2 + (t+z)^2$
    \item $\sigma_2 = R_M^2 + z^2$
    \item $\sigma_3 = R_C^2 + z^2$    
\end{itemize}

So we can model the coil-magnet system as a \textbf{Transducer} element that converts the current flowing through the coil into a force acting on the magnet.
\begin{equation}
    B_C(z, I) = \frac{\mu N I R_C^2}{2(R_C^2+z^2)^\frac{3}{2}} \rightarrow B_C(q, i) = \frac{1}{2} L(q) i
\end{equation}

\begin{figure}
    \centering
    \resizebox{.9\linewidth}{!}{\input{Chapters/Chapter2/Modelling_of_Entire_System/Figures/Coil_Magnet_Transducer.tex}}
    \caption{Coil-Magnet Transducer bond graph.}
    \label{fig:Coil-Magnet Transducer}
    \begin{equation}
        F(q, i) = \frac{1}{2} \frac{d \left(L(q) \cdot m_M(q) \right)}{dq} i
    \end{equation}
    \begin{equation}
        \lambda = L(q) i
    \end{equation}
\end{figure}
